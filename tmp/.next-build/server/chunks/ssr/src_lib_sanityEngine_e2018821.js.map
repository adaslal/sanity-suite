{"version":3,"sources":["../../../../../src/lib/sanityEngine.js"],"sourcesContent":["// ============================================================================\n// SANITY ENGINE v1.4 — Deterministic Logic Hashing\n// ============================================================================\n//\n// Sovereign Architect Philosophy:\n//   Deterministic logic, local-first execution, \"AI without AI.\"\n//\n// The 9 Rules of the Logic Hashing Grammar:\n//   R1: Tokenize (XML tag → deterministic token via FLOW_TOKEN_MAP)\n//   R2: Sequence (preserve execution order as token array)\n//   R3: Hash (SHA-256 the canonical token sequence)\n//   R4: Trace (map each token to its SEMANTIC_DICTIONARY meaning)\n//   R5: Graph (build adjacency list from connector references)\n//   R6: Warn (detect anti-patterns: DML/SOQL in loops, missing fault paths)\n//   R7: Summarize (count element types for quick structural overview)\n//   R8: Namespace Strip (optionally remove managed-package prefixes)\n//   R9: Graceful Degradation (unknown XML tags → UNK_X fallback token)\n//\n// ALL processing happens client-side in the browser.\n// No metadata is transmitted to any external server.\n//\n// Author: Abhilash | Confidential / Proprietary IP\n// ============================================================================\n\n// ============================================================================\n// GRAMMAR DICTIONARY — The \"Language of Intent\"\n// ============================================================================\n\n/**\n * Maps Salesforce Flow XML element names → deterministic tokens.\n * Unknown elements hit Rule 9 (Graceful Degradation).\n */\nconst FLOW_TOKEN_MAP = {\n    // Entry points\n    start:                'RTF_S',      // Record-Triggered / Flow Start\n\n    // Logic branching\n    decisions:            'DEC',        // Logical Decision (bifurcating path)\n\n    // DML operations (database writes)\n    recordCreates:        'DML_W',      // Insert\n    recordUpdates:        'DML_W',      // Update\n    recordDeletes:        'DML_D',      // Delete\n\n    // SOQL operations (database reads)\n    recordLookups:        'SOQL_R',     // Query\n\n    // Iteration\n    loops:                'LOOP_S',     // Loop start\n\n    // External actions\n    actionCalls:          'EXT_ACT',    // Apex action, email, etc.\n    subflows:             'SUBFLOW',    // Invoke another flow\n\n    // Assignments & resources\n    assignments:          'ASSIGN',     // Variable assignment\n    collectionProcessors: 'COLL_PROC',  // Transform / filter / sort\n\n    // Screen\n    screens:              'SCREEN',     // UI screen element\n\n    // Wait / Pause\n    waits:                'WAIT',       // Pause-resume element\n\n    // Custom error\n    customErrors:         'FAULT'       // Custom error throw\n};\n\n/**\n * Tags that are NOISE — no effect on runtime execution (Rule 1).\n */\nconst NOISE_TAGS = new Set([\n    'locationX', 'locationY',\n    'connector', 'faultConnector', 'defaultConnector',\n    'nextValueConnector', 'noMoreValuesConnector',\n    'label', 'description',\n    'processMetadataValues'\n]);\n\n/**\n * Flow-level metadata tags (not executable elements).\n */\nconst METADATA_TAGS = new Set([\n    'processType', 'apiVersion', 'status', 'interviewLabel',\n    'environments', 'runInMode', 'isTemplate', 'isOverridable',\n    'overriddenFlow', 'migratedFromWorkflowRuleName'\n]);\n\n/**\n * Resource tags (not executable — declared, not traversed).\n */\nconst RESOURCE_TAGS = new Set([\n    'variables', 'formulas', 'constants', 'textTemplates',\n    'stages', 'choices', 'dynamicChoiceSets'\n]);\n\n/**\n * SEMANTIC DICTIONARY — The \"Meaning Layer\"\n *\n * Maps every deterministic token to a Semantic Object containing:\n *   - meaning:  Human-readable sentence explaining WHAT this step does.\n *   - impact:   WHY it matters to the business or system.\n *   - category: Grouping key for visual rendering (start, logic, data, loop, action, ui, error).\n *   - shape:    SVG shape type for the Sovereign Flowchart (stadium, diamond, rect, hex, rounded, flag, octagon).\n *   - color:    Fill color for the SVG node.\n *\n * Every token the engine can emit MUST have an entry here.\n * Unknown tokens fall through to a runtime default (Rule 9 Graceful Degradation).\n */\nconst SEMANTIC_DICTIONARY = {\n    'RTF_S': {\n        meaning:  'Record-Triggered Start: The automation engine wakes up when a record is created, updated, or deleted.',\n        impact:   'This is the ignition point — every downstream operation depends on this trigger firing correctly.',\n        category: 'start',\n        shape:    'stadium',\n        color:    '#0176d3'\n    },\n    'DEC': {\n        meaning:  'Logic Gate: The system evaluates business criteria and splits the execution path into branches.',\n        impact:   'Decisions control which operations run. A misconfigured condition silently skips critical logic.',\n        category: 'logic',\n        shape:    'diamond',\n        color:    '#9b59b6'\n    },\n    'DML_W': {\n        meaning:  'Database Write: Data is permanently committed to Salesforce (Insert or Update).',\n        impact:   'Each write consumes a DML statement. Inside a loop, this will breach governor limits at scale.',\n        category: 'data',\n        shape:    'rect',\n        color:    '#e87400'\n    },\n    'DML_D': {\n        meaning:  'Database Delete: Records are permanently removed from Salesforce.',\n        impact:   'Irreversible data loss. Ensure cascade effects (lookups, triggers) are accounted for.',\n        category: 'data',\n        shape:    'rect',\n        color:    '#c23934'\n    },\n    'SOQL_R': {\n        meaning:  'Database Query: The system reads records from Salesforce using SOQL.',\n        impact:   'Each query consumes a SOQL statement. Inside a loop, this hits the 100-query governor limit.',\n        category: 'data',\n        shape:    'rect',\n        color:    '#2e844a'\n    },\n    'LOOP_S': {\n        meaning:  'Iteration Start: A repetitive cycle begins, processing each item in a collection one-by-one.',\n        impact:   'Loops amplify everything inside them. DML/SOQL inside a loop = governor limit time bomb.',\n        category: 'loop',\n        shape:    'hex',\n        color:    '#f4bc25'\n    },\n    'LOOP_E': {\n        meaning:  'Iteration End: The cycle completes. Control returns to the loop header or exits to the next step.',\n        impact:   'Marks the boundary of the amplification zone. Operations after this line are safe from loop multiplication.',\n        category: 'loop',\n        shape:    'hex',\n        color:    '#f4bc25'\n    },\n    'EXT_ACT': {\n        meaning:  'External Action: An Apex class, Email Alert, or managed-package invocable is called.',\n        impact:   'External code is a black box to the Flow engine. Errors here surface as uncatchable faults unless handled.',\n        category: 'action',\n        shape:    'rounded',\n        color:    '#0b8dff'\n    },\n    'SUBFLOW': {\n        meaning:  'Subflow Invocation: Execution is delegated to a child Flow, creating a nested transaction scope.',\n        impact:   'Subflows inherit the parent\\'s governor limits. Deep nesting can exhaust limits before the parent resumes.',\n        category: 'action',\n        shape:    'rounded',\n        color:    '#0b8dff'\n    },\n    'ASSIGN': {\n        meaning:  'Variable Assignment: A value is set, copied, or transformed within the Flow\\'s in-memory state.',\n        impact:   'Lightweight and safe — no governor impact. But incorrect assignments silently corrupt downstream logic.',\n        category: 'action',\n        shape:    'rect',\n        color:    '#706e6b'\n    },\n    'COLL_PROC': {\n        meaning:  'Collection Processor: A collection is filtered, sorted, or mapped in bulk.',\n        impact:   'Efficient in-memory operation. Preferred over loops for simple transformations.',\n        category: 'action',\n        shape:    'rect',\n        color:    '#706e6b'\n    },\n    'SCREEN': {\n        meaning:  'User Screen: A UI form or display is presented, pausing execution until the user responds.',\n        impact:   'Screens break the transaction boundary. Data may change between screens in multi-step flows.',\n        category: 'ui',\n        shape:    'flag',\n        color:    '#00b4d8'\n    },\n    'WAIT': {\n        meaning:  'Pause/Wait: Execution is suspended, awaiting an event or scheduled time to resume.',\n        impact:   'The interview is serialized to storage. Resume context may differ from the original transaction.',\n        category: 'action',\n        shape:    'rounded',\n        color:    '#706e6b'\n    },\n    'FAULT': {\n        meaning:  'Custom Error: The Flow intentionally throws a fault to halt execution and surface an error message.',\n        impact:   'Stops all downstream processing. If uncaught, the entire transaction rolls back.',\n        category: 'error',\n        shape:    'octagon',\n        color:    '#c23934'\n    },\n    '!ERR_BULK_LIMIT!': {\n        meaning:  'CRITICAL VIOLATION: A DML or SOQL operation was detected inside a Loop. This WILL fail in production with bulk data.',\n        impact:   'Governor limit breach is certain at scale. Move the operation outside the loop immediately.',\n        category: 'error',\n        shape:    'octagon',\n        color:    '#c23934'\n    }\n};\n\n/**\n * Backwards-compatible alias — the old name is still exported.\n * Internal code now uses SEMANTIC_DICTIONARY exclusively.\n */\nconst TRACE_DICTIONARY = Object.fromEntries(\n    Object.entries(SEMANTIC_DICTIONARY).map(([k, v]) => [k, v.meaning])\n);\n\n\n// ============================================================================\n// SANITY ENGINE — Core Class\n// ============================================================================\n\nclass SanityEngine {\n\n    constructor(options = {}) {\n        /** Strip managed-package namespace prefixes (Rule 8). */\n        this.stripNamespaces = options.stripNamespaces || false;\n\n        /** Collected audit warnings during analysis. */\n        this.auditWarnings = [];\n\n        /** Step-by-step logic trace. */\n        this.logicTrace = [];\n\n        /** Decision counter for sequential numbering. */\n        this._decisionCounter = 0;\n    }\n\n    // ========================================================================\n    // PUBLIC ENTRY POINT — Flow Analysis\n    // ========================================================================\n\n    /**\n     * Analyse a raw Salesforce Flow XML string.\n     * Returns a complete audit report with hash, warnings, trace, and diagram.\n     *\n     * @param {string} xmlString - Raw Flow XML\n     * @returns {Object} AuditReport\n     */\n    analyzeFlow(xmlString) {\n        const startTime = performance.now();\n        this.auditWarnings = [];\n        this.logicTrace = [];\n        this._decisionCounter = 0;\n\n        // ── Parse XML ────────────────────────────────────────────────\n        const parser = new DOMParser();\n        const doc = parser.parseFromString(xmlString, 'text/xml');\n        const parseError = doc.querySelector('parsererror');\n        if (parseError) {\n            return this._errorReport('XML Parse Error: ' + parseError.textContent.substring(0, 200));\n        }\n\n        const root = doc.documentElement;\n        if (!root || (root.localName !== 'Flow' && root.localName !== 'Workflow')) {\n            return this._errorReport('Invalid Flow XML: root element must be <Flow>.');\n        }\n\n        // ── Extract flow metadata ────────────────────────────────────\n        const flowType = this._getChildText(root, 'processType') || 'Unknown';\n        const apiVersion = this._getChildText(root, 'apiVersion') || '';\n\n        // ── Extract elements + connectors ────────────────────────────\n        const { elements, connectorMap, noiseCount } = this._extractElements(root);\n\n        // ── Build execution graph ────────────────────────────────────\n        const graph = this._buildGraph(elements, connectorMap, root);\n\n        // ── Walk graph → generate tokens (Rules 1-4, 8-9 applied) ───\n        const tokens = this._walkGraph(graph, elements);\n\n        // ── Rule 6: Bulkification audit ──────────────────────────────\n        this._auditBulkification(tokens);\n\n        // ── Build the Logic Fingerprint ──────────────────────────────\n        const hash = tokens.map(t => t.token).join(' -> ');\n\n        // ── Generate Logic Trace ─────────────────────────────────────\n        const trace = this._generateTrace(tokens);\n\n        // ── Generate Sovereign Flowchart (native SVG) ────────────────\n        const flowchartSvg = this._generateSvgFlowchart(graph, elements, tokens);\n\n        // ── Element summary ──────────────────────────────────────────\n        const summary = this._buildSummary(tokens);\n\n        const elapsed = Math.round(performance.now() - startTime);\n\n        return {\n            success: true,\n            hash,\n            tokens: tokens.map(t => t.token),\n            flowType: this._humanFlowType(flowType),\n            apiVersion,\n            elementSummary: summary,\n            warnings: [...this.auditWarnings],\n            trace,\n            flowchartSvg,\n            stats: {\n                totalElements: Object.keys(elements).length,\n                noiseStripped: noiseCount,\n                unknownTags: this.auditWarnings.filter(w => w.type === 'UNKNOWN_ELEMENT').length,\n                processingTimeMs: elapsed\n            }\n        };\n    }\n\n    // ========================================================================\n    // PUBLIC ENTRY POINT — PermSet Hashing (Rule 7)\n    // ========================================================================\n\n    /**\n     * Hash a PermissionSet XML for deterministic comparison.\n     * Extracts, normalises, sorts, and joins all permission entries.\n     *\n     * @param {string} xmlString - Raw PermissionSet XML\n     * @returns {Object} PermSet hash report\n     */\n    hashPermSet(xmlString) {\n        const parser = new DOMParser();\n        const doc = parser.parseFromString(xmlString, 'text/xml');\n        const root = doc.documentElement;\n        if (!root) return { hash: '', entries: [] };\n\n        const entries = [];\n        for (const child of root.children) {\n            const tag = child.localName;\n            if (['label', 'description', 'license', 'hasActivationRequired'].includes(tag)) continue;\n\n            const parts = [tag];\n            for (const sub of child.children) {\n                let val = this._normalizeValue(sub.textContent); // Rule 4\n                if (this.stripNamespaces) val = this._stripNs(val); // Rule 8\n                parts.push(sub.localName + '=' + val);\n            }\n            parts.sort(); // Rule 3\n            entries.push(parts.join('|'));\n        }\n        entries.sort(); // Rule 3: deterministic order\n\n        return {\n            hash: entries.join('\\n'),\n            entryCount: entries.length\n        };\n    }\n\n    /**\n     * Rule 7: Compare Source and Destination PermSet hashes.\n     * Returns orphaned entries (in source but not destination).\n     */\n    comparePermSetHashes(sourceHash, destHash) {\n        const srcSet = new Set(sourceHash.split('\\n').filter(Boolean));\n        const destSet = new Set(destHash.split('\\n').filter(Boolean));\n        const orphans = [];\n        for (const entry of srcSet) {\n            if (!destSet.has(entry)) {\n                orphans.push(entry);\n            }\n        }\n        return {\n            isSafe: orphans.length === 0,\n            orphanCount: orphans.length,\n            orphans\n        };\n    }\n\n    // ========================================================================\n    // RULE 1: Structural Noise Suppression\n    // ========================================================================\n\n    /**\n     * Determines whether a child element is functional (non-noise).\n     */\n    _isFunctional(tagName) {\n        return !NOISE_TAGS.has(tagName);\n    }\n\n    // ========================================================================\n    // RULE 2: Variable & Reference Canonicalization\n    // ========================================================================\n\n    /**\n     * Canonicalise a Salesforce reference string.\n     * {!Get_Recent_Account.Id} → [REF:Account.Id]\n     * $Record.Status → [REF:$Record.Status]\n     */\n    _canonicalizeRef(ref) {\n        if (!ref) return 'null';\n        let v = String(ref).trim();\n\n        // Strip {! ... } wrapper\n        if (v.startsWith('{!') && v.endsWith('}')) {\n            v = v.substring(2, v.length - 1);\n        }\n\n        // Rule 8: Namespace stripping\n        if (this.stripNamespaces) {\n            v = this._stripNs(v);\n        }\n\n        return '[REF:' + v + ']';\n    }\n\n    // ========================================================================\n    // RULE 3: Deterministic Intent Sorting\n    // ========================================================================\n\n    /**\n     * Compute a semantic signature for a decision rule's conditions.\n     * Used for sorting and redundancy detection.\n     */\n    _getSemanticSignature(conditionNodes) {\n        if (!conditionNodes || conditionNodes.length === 0) return 'DEFAULT_PATH';\n\n        const parts = conditionNodes.map(c => {\n            const left = this._canonicalizeRef(this._getChildText(c, 'leftValueReference'));\n            const op = this._getChildText(c, 'operator') || 'UNKNOWN_OP';\n            const rightNode = c.querySelector('rightValue');\n            const right = rightNode\n                ? this._normalizeValue(rightNode.textContent)\n                : 'null';\n            return left + ':' + op + ':' + right;\n        });\n\n        return parts.sort().join('&&');\n    }\n\n    /**\n     * Compare two decision rules for sorting.\n     * If signatures match → flag redundancy (Rule 3 extension).\n     */\n    _compareIntent(ruleA, ruleB) {\n        const hashA = this._getSemanticSignature(\n            Array.from(ruleA.querySelectorAll(':scope > conditions'))\n        );\n        const hashB = this._getSemanticSignature(\n            Array.from(ruleB.querySelectorAll(':scope > conditions'))\n        );\n\n        if (hashA === hashB && hashA !== 'DEFAULT_PATH') {\n            const nameA = this._getChildText(ruleA, 'name') || 'Unknown';\n            const nameB = this._getChildText(ruleB, 'name') || 'Unknown';\n            this.auditWarnings.push({\n                type: 'REDUNDANCY',\n                severity: 'Medium',\n                message: 'Identical logic detected in \"' + nameA + '\" and \"' + nameB + '\".',\n                detail: 'Consider merging these paths to reduce technical debt.',\n                remediation: 'Review both outcomes — if they lead to the same action, consolidate.',\n                hashSignature: hashA\n            });\n            return 0;\n        }\n        return hashA < hashB ? -1 : 1;\n    }\n\n    // ========================================================================\n    // RULE 4: Data-Type Normalisation\n    // ========================================================================\n\n    /**\n     * Normalise a value to its canonical string form.\n     */\n    _normalizeValue(value) {\n        if (value === null || value === undefined) return 'null';\n        let v = String(value).trim();\n        if (v === '') return 'null';\n\n        // Boolean normalisation\n        const lower = v.toLowerCase();\n        if (lower === 'true' || lower === 'false') return lower;\n\n        // Numeric normalisation (strip trailing zeros)\n        if (!isNaN(v) && v !== '') {\n            return parseFloat(v).toString();\n        }\n\n        // String normalisation (lowercase, trimmed)\n        return lower;\n    }\n\n    // ========================================================================\n    // RULE 5: Formula De-nesting & Operator Standardisation\n    // ========================================================================\n\n    /**\n     * Standardise a formula string for hashing.\n     * Strips redundant parentheses, normalises whitespace.\n     * Full algebraic normalisation is a Phase 2 enhancement.\n     */\n    _normalizeFormula(formula) {\n        if (!formula) return '';\n        let f = formula.trim();\n        // Collapse whitespace\n        f = f.replace(/\\s+/g, ' ');\n        // Lowercase function names\n        f = f.replace(/\\b(IF|AND|OR|NOT|ISBLANK|ISNULL|TEXT|VALUE)\\b/gi,\n            match => match.toUpperCase());\n        return f;\n    }\n\n    // ========================================================================\n    // RULE 6: Bulkification Risk Signature (The Auditor Rule)\n    // ========================================================================\n\n    /**\n     * Post-hash pass: detect DML/SOQL inside loops.\n     * Supports nested loops via depth counter.\n     */\n    _auditBulkification(tokenList) {\n        let loopDepth = 0;\n\n        for (const entry of tokenList) {\n            const t = entry.token;\n\n            if (t.includes('[LOOP_S]'))  { loopDepth++; }\n            if (t.includes('[LOOP_E]'))  { loopDepth = Math.max(0, loopDepth - 1); }\n\n            if (loopDepth > 0 && (t.includes('[DML_W]') || t.includes('[DML_D]'))) {\n                this.auditWarnings.push({\n                    type: 'CRITICAL_RISK',\n                    severity: 'Critical',\n                    message: 'Governor Limit Risk: DML inside Loop detected.',\n                    detail: 'Element \"' + (entry.name || 'unknown') + '\" performs a database write inside a loop. ' +\n                            'This will cause \"Too Many DML Statements\" in production with bulk data.',\n                    remediation: 'Move DML outside the loop. Collect records in a Collection variable, then perform a single bulk DML after the loop.',\n                    hashSignature: t\n                });\n                // Append risk flag to the token sequence\n                tokenList.push({\n                    token: '!ERR_BULK_LIMIT!',\n                    name: '_risk_flag',\n                    elementType: 'risk'\n                });\n            }\n\n            if (loopDepth > 0 && t.includes('[SOQL_R]')) {\n                this.auditWarnings.push({\n                    type: 'CRITICAL_RISK',\n                    severity: 'Critical',\n                    message: 'Governor Limit Risk: SOQL inside Loop detected.',\n                    detail: 'Element \"' + (entry.name || 'unknown') + '\" performs a database query inside a loop. ' +\n                            'This will cause \"Too Many SOQL Queries\" in production with bulk data.',\n                    remediation: 'Move the query before the loop. Use a single query to retrieve all needed records, then loop over the results.',\n                    hashSignature: t\n                });\n                tokenList.push({\n                    token: '!ERR_BULK_LIMIT!',\n                    name: '_risk_flag',\n                    elementType: 'risk'\n                });\n            }\n        }\n    }\n\n    // ========================================================================\n    // RULE 8: Namespace Abstraction (The AppExchange Rule)\n    // ========================================================================\n\n    /**\n     * Strip managed-package namespace prefixes.\n     * pse__Timecard__c → Timecard__c\n     */\n    _stripNs(name) {\n        if (!name) return name;\n        return name.replace(/^[a-zA-Z0-9]+__/g, '');\n    }\n\n    // ========================================================================\n    // RULE 9: Graceful Degradation (The \"Future-Proof\" Rule)\n    // ========================================================================\n\n    /**\n     * Generate a token for any element. Unknown elements produce [UNKNOWN:tag].\n     */\n    _tokenize(tagName, elementName) {\n        const mapped = FLOW_TOKEN_MAP[tagName];\n        if (mapped) {\n            if (mapped === 'DEC') {\n                this._decisionCounter++;\n                const num = String(this._decisionCounter).padStart(2, '0');\n                return '[DEC_' + num + ']';\n            }\n            return '[' + mapped + ']';\n        }\n\n        // Rule 9: Unknown element — flag, don't drop\n        this.auditWarnings.push({\n            type: 'UNKNOWN_ELEMENT',\n            severity: 'Low',\n            message: 'Unknown element type: <' + tagName + '>',\n            detail: 'Element \"' + (elementName || tagName) + '\" is outside the current Grammar Dictionary. ' +\n                    'Its raw signature is included in the hash to maintain audit integrity.',\n            remediation: 'No action needed. This element was preserved in the hash for traceability.',\n            hashSignature: '[UNKNOWN:' + tagName + ']'\n        });\n        return '[UNKNOWN:' + tagName + ']';\n    }\n\n    // ========================================================================\n    // INTERNAL: XML Element Extraction\n    // ========================================================================\n\n    /**\n     * Walk the Flow XML root and extract all executable elements + connectors.\n     */\n    _extractElements(root) {\n        const elements = {};    // name → { tag, node, connectors }\n        const connectorMap = {}; // name → { next, default, fault, loopBody, loopExit }\n        let noiseCount = 0;\n\n        for (const child of root.children) {\n            const tag = child.localName;\n\n            // Skip metadata, resources, and noise\n            if (METADATA_TAGS.has(tag) || RESOURCE_TAGS.has(tag)) continue;\n            if (NOISE_TAGS.has(tag)) { noiseCount++; continue; }\n\n            const name = this._getChildText(child, 'name');\n            if (!name && tag !== 'start') continue;\n\n            const elName = name || '__start__';\n            elements[elName] = { tag, node: child, name: elName };\n\n            // Extract connectors for graph building\n            const conn = {};\n            const nextConn = child.querySelector(':scope > connector > targetReference');\n            if (nextConn) conn.next = nextConn.textContent.trim();\n\n            const defConn = child.querySelector(':scope > defaultConnector > targetReference');\n            if (defConn) conn.default = defConn.textContent.trim();\n\n            const faultConn = child.querySelector(':scope > faultConnector > targetReference');\n            if (faultConn) conn.fault = faultConn.textContent.trim();\n\n            // Loop-specific connectors\n            const bodyConn = child.querySelector(':scope > nextValueConnector > targetReference');\n            if (bodyConn) conn.loopBody = bodyConn.textContent.trim();\n\n            const exitConn = child.querySelector(':scope > noMoreValuesConnector > targetReference');\n            if (exitConn) conn.loopExit = exitConn.textContent.trim();\n\n            // Decision rules → individual branch connectors\n            if (tag === 'decisions') {\n                const rules = Array.from(child.querySelectorAll(':scope > rules'));\n                // Rule 3: Sort decision rules by semantic signature\n                rules.sort((a, b) => this._compareIntent(a, b));\n                conn.rules = rules.map(r => {\n                    const rName = this._getChildText(r, 'name') || 'unknown';\n                    const rConn = r.querySelector(':scope > connector > targetReference');\n                    return {\n                        name: rName,\n                        ruleNode: r,\n                        target: rConn ? rConn.textContent.trim() : null\n                    };\n                });\n            }\n\n            // Count noise stripped from this element (Rule 1)\n            for (const sub of child.children) {\n                if (NOISE_TAGS.has(sub.localName)) noiseCount++;\n            }\n\n            connectorMap[elName] = conn;\n        }\n\n        return { elements, connectorMap, noiseCount };\n    }\n\n    // ========================================================================\n    // INTERNAL: Graph Construction\n    // ========================================================================\n\n    _buildGraph(elements, connectorMap, root) {\n        const graph = {}; // name → [{ target, label }]\n\n        for (const [name, conn] of Object.entries(connectorMap)) {\n            const edges = [];\n            const el = elements[name];\n            if (!el) continue;\n\n            if (el.tag === 'loops') {\n                // Loop: body path + exit path\n                if (conn.loopBody) edges.push({ target: conn.loopBody, label: 'each_item', type: 'loopBody' });\n                if (conn.loopExit) edges.push({ target: conn.loopExit, label: 'done', type: 'loopExit' });\n            } else if (el.tag === 'decisions' && conn.rules) {\n                // Decision: each rule is a branch\n                for (const rule of conn.rules) {\n                    if (rule.target) {\n                        edges.push({ target: rule.target, label: rule.name, type: 'branch' });\n                    }\n                }\n                if (conn.default) edges.push({ target: conn.default, label: 'default', type: 'default' });\n            } else {\n                if (conn.next)    edges.push({ target: conn.next, label: 'next', type: 'next' });\n                if (conn.default) edges.push({ target: conn.default, label: 'default', type: 'default' });\n            }\n\n            if (conn.fault) edges.push({ target: conn.fault, label: 'fault', type: 'fault' });\n\n            graph[name] = edges;\n        }\n\n        return graph;\n    }\n\n    // ========================================================================\n    // INTERNAL: Graph Walk → Token Sequence\n    // ========================================================================\n\n    /**\n     * DFS traversal of the execution graph.\n     * Produces an ordered token sequence representing the flow's logic.\n     */\n    _walkGraph(graph, elements) {\n        const tokens = [];\n        const visited = new Set();\n\n        const walk = (name) => {\n            if (!name || visited.has(name)) return;\n            visited.add(name);\n\n            const el = elements[name];\n            if (!el) return;\n\n            const token = this._tokenize(el.tag, el.name);\n            tokens.push({ token, name: el.name, elementType: el.tag });\n\n            // If this is a loop, mark body entry and exit\n            const edges = graph[name] || [];\n\n            if (el.tag === 'loops') {\n                // Walk the loop body\n                const bodyEdge = edges.find(e => e.type === 'loopBody');\n                const exitEdge = edges.find(e => e.type === 'loopExit');\n\n                if (bodyEdge) {\n                    walk(bodyEdge.target);\n                }\n                // Emit LOOP_E after body\n                tokens.push({ token: '[LOOP_E]', name: el.name + '_end', elementType: 'loopEnd' });\n\n                // Walk the exit path\n                if (exitEdge) {\n                    walk(exitEdge.target);\n                }\n            } else if (el.tag === 'decisions') {\n                // Walk each branch\n                for (const edge of edges) {\n                    walk(edge.target);\n                }\n            } else {\n                // Linear: follow edges\n                for (const edge of edges) {\n                    if (edge.type !== 'fault') {\n                        walk(edge.target);\n                    }\n                }\n            }\n        };\n\n        // Find the start element\n        const startEl = elements['__start__'];\n        if (startEl) {\n            tokens.push({ token: '[RTF_S]', name: '__start__', elementType: 'start' });\n            const startEdges = graph['__start__'] || [];\n            for (const edge of startEdges) {\n                walk(edge.target);\n            }\n        } else {\n            // Fallback: walk all elements that aren't targets of others\n            const allTargets = new Set();\n            for (const edges of Object.values(graph)) {\n                for (const e of edges) allTargets.add(e.target);\n            }\n            for (const name of Object.keys(elements)) {\n                if (!allTargets.has(name) && name !== '__start__') {\n                    walk(name);\n                }\n            }\n        }\n\n        return tokens;\n    }\n\n    // ========================================================================\n    // LOGIC TRACE — Semantic Meaning Extraction\n    // ========================================================================\n\n    /**\n     * Look up the Semantic Dictionary entry for a token.\n     * Handles numbered variants like [DEC_01] → strips _NN to find base key.\n     * Falls back to Rule 9 default for unknown tokens.\n     */\n    _lookupSemantic(token) {\n        // Strip bracket wrappers: [DML_W] → DML_W\n        const stripped = token.replace(/[\\[\\]!]/g, '');\n        // Try exact match first (handles !ERR_BULK_LIMIT!)\n        if (SEMANTIC_DICTIONARY[token])    return SEMANTIC_DICTIONARY[token];\n        if (SEMANTIC_DICTIONARY[stripped]) return SEMANTIC_DICTIONARY[stripped];\n        // Strip numeric suffix: DEC_01 → DEC\n        const base = stripped.replace(/_\\d+$/, '');\n        if (SEMANTIC_DICTIONARY[base])     return SEMANTIC_DICTIONARY[base];\n        // Rule 9: Unknown token fallback\n        return {\n            meaning:  'Unknown element encountered: ' + token,\n            impact:   'This element type is not yet mapped in the Semantic Dictionary.',\n            category: 'action',\n            shape:    'rect',\n            color:    '#b0adab'\n        };\n    }\n\n    _generateTrace(tokens) {\n        return tokens.map((entry, idx) => {\n            const semantic = this._lookupSemantic(entry.token);\n\n            // Override for synthetic loop-end tokens\n            const isLoopEnd = entry.elementType === 'loopEnd';\n            const loopEndSemantic = SEMANTIC_DICTIONARY['LOOP_E'];\n\n            return {\n                step: idx + 1,\n                token: entry.token,\n                elementName: entry.name,\n                explanation: isLoopEnd ? loopEndSemantic.meaning : semantic.meaning,\n                impact:      isLoopEnd ? loopEndSemantic.impact  : semantic.impact,\n                category:    isLoopEnd ? loopEndSemantic.category : semantic.category\n            };\n        });\n    }\n\n    // ========================================================================\n    // VISUAL TRUTH — Sovereign Flowchart (Pure SVG, Zero Dependencies)\n    // ========================================================================\n\n    /**\n     * Generate a complete SVG flowchart from the execution graph.\n     * Returns raw SVG markup string that can be injected via innerHTML.\n     *\n     * 100% local. No Mermaid. No external libraries. Pure geometry.\n     *\n     * Shape vocabulary:\n     *   Stadium (rounded pill)  — Start / End\n     *   Diamond                 — Decisions\n     *   Rectangle               — DML, SOQL, Assignments\n     *   Hexagon                 — Loops\n     *   Rounded Rectangle       — External Actions, Subflows, Waits\n     *   Flag (asymmetric)       — Screens\n     *   Octagon                 — Errors / Faults\n     */\n    _generateSvgFlowchart(graph, elements, tokens) {\n\n        // ── Layout constants (v2 — proportional spacing) ─────────────\n        const NODE_W      = 240;       // Node width\n        const NODE_H      = 48;        // Default node height\n        const NODE_H_DIA  = 80;        // Diamond needs extra vertical room\n        const GAP_Y       = 120;       // Vertical gap between nodes (breathing room)\n        const BRANCH_GAP  = 300;       // Horizontal gap between decision branches\n        const PAD         = 60;        // Canvas padding\n        const FONT_SIZE   = 12;\n        const SUB_FONT    = 10;        // Sub-label font size\n        const LABEL_SIZE  = 10;\n        const ARROW_SIZE  = 7;\n        const STROKE_W    = 2;         // Shape stroke width\n        const RX          = 8;         // Rounded rect corner radius\n\n        // ── Collect ordered nodes via DFS ────────────────────────────\n        const nodeOrder = [];\n        const visited   = new Set();\n        const nodeMap   = {};\n\n        const walkOrder = (name) => {\n            if (!name || visited.has(name)) return;\n            visited.add(name);\n            const el = elements[name];\n            if (!el) return;\n            nodeOrder.push(name);\n            const edges = graph[name] || [];\n            for (const e of edges) walkOrder(e.target);\n        };\n\n        if (elements['__start__']) walkOrder('__start__');\n        for (const name of Object.keys(elements)) {\n            if (!visited.has(name)) walkOrder(name);\n        }\n\n        if (nodeOrder.length === 0) {\n            return '<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"60\">' +\n                   '<rect width=\"100%\" height=\"100%\" fill=\"#1b2531\" rx=\"8\"/>' +\n                   '<text x=\"200\" y=\"35\" text-anchor=\"middle\" fill=\"#8c9cb0\" font-size=\"13\" font-family=\"sans-serif\">No executable elements found</text></svg>';\n        }\n\n        // ── Assign positions (vertical with branch columns) ─────────\n        const branchCols = {};\n        for (const name of nodeOrder) {\n            const el = elements[name];\n            if (!el || el.tag !== 'decisions') continue;\n            const edges = graph[name] || [];\n            edges.forEach((edge, i) => {\n                if (i > 0 && edge.target) branchCols[edge.target] = i;\n            });\n        }\n\n        let cursorY = PAD;\n        let maxX    = 0;\n\n        for (const name of nodeOrder) {\n            const el       = elements[name];\n            const semantic = this._lookupSemantic(this._tokenize(el.tag, el.name));\n            const isDiamond = semantic.shape === 'diamond';\n            const h        = isDiamond ? NODE_H_DIA : NODE_H;\n            const col      = branchCols[name] || 0;\n            const x        = PAD + (col * BRANCH_GAP);\n\n            nodeMap[name] = {\n                x, y: cursorY, w: NODE_W, h,\n                cx: x + NODE_W / 2,\n                cy: cursorY + h / 2,\n                bottom: cursorY + h,\n                label: name === '__start__' ? 'Flow Start' : el.name,\n                tag: el.tag,\n                semantic\n            };\n\n            maxX = Math.max(maxX, x + NODE_W);\n            cursorY += h + GAP_Y;\n        }\n\n        // Dynamic viewBox scales to content\n        const totalW = Math.max(maxX + PAD, 400);\n        const totalH = cursorY - GAP_Y + PAD + 20;\n\n        // ── Helpers ──────────────────────────────────────────────────\n        const esc = (s) => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n        const truncate = (text, maxLen) => text.length <= maxLen ? text : text.substring(0, maxLen - 1) + '\\u2026';\n\n        // Lighten a hex color for stroke\n        const strokeColor = (hex) => {\n            const r = parseInt(hex.slice(1, 3), 16);\n            const g = parseInt(hex.slice(3, 5), 16);\n            const b = parseInt(hex.slice(5, 7), 16);\n            const lighten = (c) => Math.min(255, c + 40);\n            return '#' + [lighten(r), lighten(g), lighten(b)].map(c => c.toString(16).padStart(2, '0')).join('');\n        };\n\n        // ── Shape renderers (v2 — distinct strokes, modern rx) ──────\n        const shapes = {\n            stadium: (n) => {\n                const r = n.h / 2;\n                return '<rect x=\"' + n.x + '\" y=\"' + n.y + '\" width=\"' + n.w + '\" height=\"' + n.h + '\" rx=\"' + r + '\" ry=\"' + r + '\" ' +\n                       'fill=\"' + n.semantic.color + '\" stroke=\"' + strokeColor(n.semantic.color) + '\" stroke-width=\"' + STROKE_W + '\"/>';\n            },\n            diamond: (n) => {\n                const cx = n.cx, cy = n.cy, hw = n.w * 0.5, hh = n.h * 0.5;\n                const pts = cx + ',' + (cy - hh) + ' ' + (cx + hw) + ',' + cy + ' ' + cx + ',' + (cy + hh) + ' ' + (cx - hw) + ',' + cy;\n                return '<polygon points=\"' + pts + '\" fill=\"' + n.semantic.color + '\" stroke=\"' + strokeColor(n.semantic.color) + '\" stroke-width=\"' + STROKE_W + '\" stroke-linejoin=\"round\"/>';\n            },\n            rect: (n) => {\n                return '<rect x=\"' + n.x + '\" y=\"' + n.y + '\" width=\"' + n.w + '\" height=\"' + n.h + '\" rx=\"' + RX + '\" ry=\"' + RX + '\" ' +\n                       'fill=\"' + n.semantic.color + '\" stroke=\"' + strokeColor(n.semantic.color) + '\" stroke-width=\"' + STROKE_W + '\"/>';\n            },\n            hex: (n) => {\n                const inset = 18;\n                const pts = (n.x + inset) + ',' + n.y + ' ' +\n                            (n.x + n.w - inset) + ',' + n.y + ' ' +\n                            (n.x + n.w) + ',' + n.cy + ' ' +\n                            (n.x + n.w - inset) + ',' + (n.y + n.h) + ' ' +\n                            (n.x + inset) + ',' + (n.y + n.h) + ' ' +\n                            n.x + ',' + n.cy;\n                return '<polygon points=\"' + pts + '\" fill=\"' + n.semantic.color + '\" stroke=\"' + strokeColor(n.semantic.color) + '\" stroke-width=\"' + STROKE_W + '\" stroke-linejoin=\"round\"/>';\n            },\n            rounded: (n) => {\n                return '<rect x=\"' + n.x + '\" y=\"' + n.y + '\" width=\"' + n.w + '\" height=\"' + n.h + '\" rx=\"16\" ry=\"16\" ' +\n                       'fill=\"' + n.semantic.color + '\" stroke=\"' + strokeColor(n.semantic.color) + '\" stroke-width=\"' + STROKE_W + '\"/>';\n            },\n            flag: (n) => {\n                const pts = n.x + ',' + n.y + ' ' +\n                            (n.x + n.w - 16) + ',' + n.y + ' ' +\n                            (n.x + n.w) + ',' + n.cy + ' ' +\n                            (n.x + n.w - 16) + ',' + (n.y + n.h) + ' ' +\n                            n.x + ',' + (n.y + n.h);\n                return '<polygon points=\"' + pts + '\" fill=\"' + n.semantic.color + '\" stroke=\"' + strokeColor(n.semantic.color) + '\" stroke-width=\"' + STROKE_W + '\" stroke-linejoin=\"round\"/>';\n            },\n            octagon: (n) => {\n                const c = 14;\n                const pts = (n.x + c) + ',' + n.y + ' ' + (n.x + n.w - c) + ',' + n.y + ' ' +\n                            (n.x + n.w) + ',' + (n.y + c) + ' ' + (n.x + n.w) + ',' + (n.y + n.h - c) + ' ' +\n                            (n.x + n.w - c) + ',' + (n.y + n.h) + ' ' + (n.x + c) + ',' + (n.y + n.h) + ' ' +\n                            n.x + ',' + (n.y + n.h - c) + ' ' + n.x + ',' + (n.y + c);\n                return '<polygon points=\"' + pts + '\" fill=\"' + n.semantic.color + '\" stroke=\"' + strokeColor(n.semantic.color) + '\" stroke-width=\"' + STROKE_W + '\" stroke-linejoin=\"round\"/>';\n            }\n        };\n\n        // ── Build SVG ────────────────────────────────────────────────\n        const svgParts = [];\n\n        // Defs: arrowhead marker + drop shadow\n        svgParts.push('<defs>');\n        svgParts.push('  <marker id=\"sov-arrow\" viewBox=\"0 0 12 12\" refX=\"11\" refY=\"6\" markerWidth=\"' + ARROW_SIZE + '\" markerHeight=\"' + ARROW_SIZE + '\" orient=\"auto-start-reverse\">');\n        svgParts.push('    <path d=\"M 0 1 L 11 6 L 0 11 z\" fill=\"#6b7b8d\"/>');\n        svgParts.push('  </marker>');\n        svgParts.push('  <filter id=\"sov-shadow\" x=\"-5%\" y=\"-5%\" width=\"110%\" height=\"120%\">');\n        svgParts.push('    <feDropShadow dx=\"0\" dy=\"3\" stdDeviation=\"4\" flood-color=\"#000000\" flood-opacity=\"0.18\"/>');\n        svgParts.push('  </filter>');\n        svgParts.push('</defs>');\n\n        // Background\n        svgParts.push('<rect width=\"100%\" height=\"100%\" fill=\"#1b2531\" rx=\"10\"/>');\n\n        // ── Draw edges (behind nodes) ────────────────────────────────\n        for (const name of nodeOrder) {\n            const src = nodeMap[name];\n            if (!src) continue;\n            const edges = graph[name] || [];\n\n            for (const edge of edges) {\n                const tgt = nodeMap[edge.target];\n                if (!tgt) continue;\n\n                const x1 = src.cx;\n                const y1 = src.bottom;           // from bottom of source\n                const x2 = tgt.cx;\n                const y2 = tgt.y;                // to top of target\n\n                if (Math.abs(x1 - x2) < 5) {\n                    // Straight vertical connector\n                    svgParts.push('<line x1=\"' + x1 + '\" y1=\"' + y1 + '\" x2=\"' + x2 + '\" y2=\"' + y2 + '\" stroke=\"#5a6a7d\" stroke-width=\"2\" marker-end=\"url(#sov-arrow)\"/>');\n                } else {\n                    // Bezier curve for cross-branch connectors\n                    const cp1y = y1 + (y2 - y1) * 0.35;\n                    const cp2y = y1 + (y2 - y1) * 0.65;\n                    svgParts.push('<path d=\"M ' + x1 + ' ' + y1 + ' C ' + x1 + ' ' + cp1y + ', ' + x2 + ' ' + cp2y + ', ' + x2 + ' ' + y2 + '\" ' +\n                                  'fill=\"none\" stroke=\"#5a6a7d\" stroke-width=\"2\" stroke-dasharray=\"6,4\" marker-end=\"url(#sov-arrow)\"/>');\n                }\n\n                // Edge label (centered on connector midpoint)\n                if (edge.label && edge.label !== 'next') {\n                    const lx = (x1 + x2) / 2 + (x1 === x2 ? 0 : 8);\n                    const ly = (y1 + y2) / 2;\n                    svgParts.push('<rect x=\"' + (lx - 28) + '\" y=\"' + (ly - 8) + '\" width=\"56\" height=\"16\" rx=\"4\" fill=\"#1b2531\" stroke=\"#5a6a7d\" stroke-width=\"0.5\"/>');\n                    svgParts.push('<text x=\"' + lx + '\" y=\"' + (ly + 3) + '\" text-anchor=\"middle\" fill=\"#8c9cb0\" font-size=\"' + LABEL_SIZE + '\" font-family=\"sans-serif\" font-style=\"italic\">' + esc(truncate(edge.label, 10)) + '</text>');\n                }\n            }\n        }\n\n        // ── Draw nodes ───────────────────────────────────────────────\n        for (const name of nodeOrder) {\n            const n = nodeMap[name];\n            if (!n) continue;\n            const shapeFn = shapes[n.semantic.shape] || shapes.rect;\n            const isDark = n.semantic.color === '#f4bc25';\n            const textColor = isDark ? '#1b2531' : '#ffffff';\n\n            // Shadow + shape\n            svgParts.push('<g filter=\"url(#sov-shadow)\">');\n            svgParts.push(shapeFn(n));\n            svgParts.push('</g>');\n\n            // Primary label (element name)\n            const displayLabel = truncate(n.label, 28);\n            svgParts.push('<text x=\"' + n.cx + '\" y=\"' + (n.cy - 2) + '\" text-anchor=\"middle\" dominant-baseline=\"middle\" ' +\n                          'fill=\"' + textColor + '\" font-size=\"' + FONT_SIZE + '\" font-weight=\"700\" font-family=\"\\'SF Mono\\', Consolas, Monaco, monospace\">' +\n                          esc(displayLabel) + '</text>');\n\n            // Sub-label (token badge below the name — for non-start nodes)\n            if (n.tag !== 'start' && name !== '__start__') {\n                const tok = this._tokenize(n.tag, n.label);\n                svgParts.push('<text x=\"' + n.cx + '\" y=\"' + (n.cy + 14) + '\" text-anchor=\"middle\" dominant-baseline=\"middle\" ' +\n                              'fill=\"' + textColor + '\" font-size=\"' + SUB_FONT + '\" font-weight=\"400\" font-family=\"sans-serif\" opacity=\"0.7\">' +\n                              esc(tok) + '</text>');\n            }\n        }\n\n        // ── Legend (top-right corner) ──────────────────────────────────\n        const legendItems = [\n            { shape: 'stadium', label: 'Start', color: '#0176d3' },\n            { shape: 'diamond', label: 'Decision', color: '#9b59b6' },\n            { shape: 'rect',    label: 'DML/SOQL', color: '#e87400' },\n            { shape: 'hex',     label: 'Loop', color: '#f4bc25' },\n            { shape: 'rounded', label: 'Action', color: '#0b8dff' },\n            { shape: 'octagon', label: 'Error', color: '#c23934' }\n        ];\n        const legendX = totalW - 135;\n        let legendY = PAD + 10;\n        // Semi-transparent background panel for the legend — wrapped in a <g> so it can be hidden inline\n        const legendH = legendItems.length * 22 + 24;\n        svgParts.push('<g data-legend=\"true\">');\n        svgParts.push('<rect x=\"' + (legendX - 10) + '\" y=\"' + (legendY - 20) + '\" width=\"130\" height=\"' + legendH + '\" rx=\"6\" fill=\"#1b2531\" fill-opacity=\"0.85\" stroke=\"#3a4a5c\" stroke-width=\"1\"/>');\n        svgParts.push('<text x=\"' + legendX + '\" y=\"' + (legendY - 4) + '\" fill=\"#8c9cb0\" font-size=\"9\" font-weight=\"700\" font-family=\"sans-serif\" letter-spacing=\"0.1em\">LEGEND</text>');\n        legendY += 8;\n        for (const item of legendItems) {\n            svgParts.push('<rect x=\"' + legendX + '\" y=\"' + legendY + '\" width=\"14\" height=\"14\" rx=\"3\" fill=\"' + item.color + '\"/>');\n            svgParts.push('<text x=\"' + (legendX + 20) + '\" y=\"' + (legendY + 11) + '\" fill=\"#8c9cb0\" font-size=\"10\" font-family=\"sans-serif\">' + item.label + '</text>');\n            legendY += 22;\n        }\n        svgParts.push('</g>');\n\n        // ── Assemble final SVG with dynamic viewBox ──────────────────\n        return '<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 ' + totalW + ' ' + totalH + '\" ' +\n               'width=\"100%\" preserveAspectRatio=\"xMidYMin meet\" ' +\n               'style=\"border-radius: 0.5rem; background: #1b2531;\">' +\n               svgParts.join('\\n') + '</svg>';\n    }\n\n    // ========================================================================\n    // INTERNAL HELPERS\n    // ========================================================================\n\n    _getChildText(parent, tagName) {\n        // Try with namespace and without\n        for (const child of parent.children) {\n            if (child.localName === tagName) {\n                return child.textContent.trim();\n            }\n        }\n        return null;\n    }\n\n    _humanFlowType(processType) {\n        const map = {\n            'AutoLaunchedFlow':     'Autolaunched Flow',\n            'Flow':                 'Screen Flow',\n            'RecordTriggeredFlow':  'Record-Triggered Flow',\n            'Workflow':             'Record-Triggered Flow (Workflow)',\n            'CustomEvent':          'Platform Event Flow',\n            'InvocableProcess':     'Invocable Process',\n            'RecordBeforeSave':     'Before-Save Flow',\n            'RecordAfterSave':      'After-Save Flow',\n            'Schedule':             'Scheduled Flow',\n            'PlatformEvent':        'Platform Event Flow'\n        };\n        return map[processType] || processType;\n    }\n\n    _buildSummary(tokens) {\n        const summary = {\n            decisions: 0,\n            dmlWrites: 0,\n            dmlDeletes: 0,\n            queries: 0,\n            loops: 0,\n            screens: 0,\n            actions: 0,\n            assignments: 0,\n            subflows: 0,\n            unknowns: 0,\n            riskFlags: 0\n        };\n\n        for (const entry of tokens) {\n            const t = entry.token;\n            if (t.startsWith('[DEC_'))   summary.decisions++;\n            else if (t === '[DML_W]')    summary.dmlWrites++;\n            else if (t === '[DML_D]')    summary.dmlDeletes++;\n            else if (t === '[SOQL_R]')   summary.queries++;\n            else if (t === '[LOOP_S]')   summary.loops++;\n            else if (t === '[SCREEN]')   summary.screens++;\n            else if (t === '[EXT_ACT]')  summary.actions++;\n            else if (t === '[ASSIGN]')   summary.assignments++;\n            else if (t === '[SUBFLOW]')  summary.subflows++;\n            else if (t.startsWith('[UNKNOWN:')) summary.unknowns++;\n            else if (t === '!ERR_BULK_LIMIT!') summary.riskFlags++;\n        }\n\n        return summary;\n    }\n\n    _errorReport(message) {\n        return {\n            success: false,\n            hash: '',\n            tokens: [],\n            flowType: 'Unknown',\n            apiVersion: '',\n            elementSummary: {},\n            warnings: [{ type: 'PARSE_ERROR', severity: 'Critical', message, detail: '', remediation: 'Check XML validity.' }],\n            trace: [],\n            flowchartSvg: '',\n            stats: { totalElements: 0, noiseStripped: 0, unknownTags: 0, processingTimeMs: 0 }\n        };\n    }\n}\n\n// ============================================================================\n// EXPORTS\n// ============================================================================\n\nexport { SanityEngine, FLOW_TOKEN_MAP, SEMANTIC_DICTIONARY, TRACE_DICTIONARY };\n"],"names":[],"mappings":"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"}